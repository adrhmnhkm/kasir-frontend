<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Struk Pembayaran</title>
    <style>
        body {
            font-family: 'Courier New', monospace;
            font-size: 12px;
            line-height: 1.2;
            margin: 0;
            padding: 10px;
            width: 280px;
            background: white;
        }
        
        .receipt {
            width: 100%;
        }
        
        .header {
            text-align: center;
            border-bottom: 1px dashed #000;
            padding-bottom: 10px;
            margin-bottom: 10px;
        }
        
        .store-name {
            font-size: 16px;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .store-info {
            font-size: 10px;
            margin-bottom: 3px;
        }
        
        .transaction-info {
            margin-bottom: 10px;
            border-bottom: 1px dashed #000;
            padding-bottom: 10px;
        }
        
        .items-table {
            width: 100%;
            margin-bottom: 10px;
        }
        
        .items-header {
            border-bottom: 1px solid #000;
            padding-bottom: 3px;
            margin-bottom: 5px;
            font-weight: bold;
        }
        
        .item-row {
            margin-bottom: 3px;
            display: flex;
            justify-content: space-between;
        }
        
        .item-name {
            width: 60%;
        }
        
        .item-qty {
            width: 15%;
            text-align: center;
        }
        
        .item-price {
            width: 25%;
            text-align: right;
        }
        
        .subtotal {
            border-top: 1px dashed #000;
            padding-top: 5px;
            margin-top: 10px;
        }
        
        .total-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 3px;
        }
        
        .total-final {
            font-weight: bold;
            font-size: 14px;
            border-top: 1px solid #000;
            padding-top: 5px;
            margin-top: 5px;
        }
        
        .payment-info {
            border-top: 1px dashed #000;
            padding-top: 10px;
            margin-top: 10px;
        }
        
        .footer {
            text-align: center;
            border-top: 1px dashed #000;
            padding-top: 10px;
            margin-top: 15px;
            font-size: 10px;
        }
        
        @media print {
            body {
                width: auto;
            }
        }
    </style>
</head>
<body>
    <div class="receipt" id="receipt">
        <div class="header">
            <div class="store-name" id="storeName">Aplikasi Kasir v1.0</div>
            <div class="store-info" id="storeAddress">Jl. Contoh No. 123, Kota</div>
            <div class="store-info" id="storePhone">Telp: 021-12345678</div>
        </div>
        
        <div class="transaction-info">
            <div>No. Struk: <span id="invoiceNumber">INV20240101001</span></div>
            <div>Tanggal: <span id="transactionDate">01/01/2024 10:30</span></div>
            <div>Kasir: <span id="cashierName">Admin</span></div>
        </div>
        
        <div class="items-table">
            <div class="items-header">
                <div style="display: flex; justify-content: space-between;">
                    <span style="width: 60%;">Item</span>
                    <span style="width: 15%; text-align: center;">Qty</span>
                    <span style="width: 25%; text-align: right;">Harga</span>
                </div>
            </div>
            <div id="itemsList">
                <!-- Items will be inserted here -->
            </div>
        </div>
        
        <div class="subtotal">
            <div class="total-row">
                <span>Subtotal:</span>
                <span id="subtotalAmount">Rp 0</span>
            </div>
            <div class="total-row">
                <span>Diskon:</span>
                <span id="discountAmount">Rp 0</span>
            </div>
            <div class="total-row total-final">
                <span>TOTAL:</span>
                <span id="totalAmount">Rp 0</span>
            </div>
        </div>
        
        <div class="payment-info">
            <div class="total-row">
                <span>Bayar:</span>
                <span id="paidAmount">Rp 0</span>
            </div>
            <div class="total-row">
                <span>Kembali:</span>
                <span id="changeAmount">Rp 0</span>
            </div>
        </div>
        
        <div class="footer">
            <div>Terima kasih atas kunjungan Anda</div>
            <div>Barang yang sudah dibeli tidak dapat dikembalikan</div>
            <div style="margin-top: 10px;">*** STRUK ASLI ***</div>
        </div>
    </div>

    <script>
        // Format currency
        const formatCurrency = (amount) => {
            return new Intl.NumberFormat('id-ID', {
                style: 'currency',
                currency: 'IDR',
                minimumFractionDigits: 0
            }).format(amount);
        };

        // Get sale ID from URL
        const getSaleId = () => {
            const pathParts = window.location.pathname.split('/');
            return pathParts[pathParts.length - 1];
        };

        // API configuration
        const API_BASE_URL = 'https://kasir-frontend-production.up.railway.app/api';
        
        // Load receipt data
        const loadReceiptData = async () => {
            try {
                const saleId = getSaleId();
                const response = await fetch(`${API_BASE_URL}/sales/${saleId}`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    credentials: 'include'
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                
                if (data.error) {
                    throw new Error(data.error);
                }

                // Update receipt content
                document.getElementById('invoiceNumber').textContent = data.invoice_number;
                document.getElementById('transactionDate').textContent = new Date(data.created_at).toLocaleString('id-ID');
                document.getElementById('cashierName').textContent = data.cashier || 'Kasir';
                
                // Build items list
                const itemsList = document.getElementById('itemsList');
                itemsList.innerHTML = '';
                
                if (data.items && data.items.length > 0) {
                  data.items.forEach(item => {
                    const itemRow = document.createElement('div');
                    itemRow.className = 'item-row';
                    
                    const itemName = document.createElement('div');
                    itemName.className = 'item-name';
                    itemName.textContent = item.product_name;
                    
                    const itemQty = document.createElement('div');
                    itemQty.className = 'item-qty';
                    itemQty.textContent = item.quantity;
                    
                    const itemPrice = document.createElement('div');
                    itemPrice.className = 'item-price';
                    itemPrice.textContent = formatCurrency(item.total);
                    
                    itemRow.appendChild(itemName);
                    itemRow.appendChild(itemQty);
                    itemRow.appendChild(itemPrice);
                    
                    itemsList.appendChild(itemRow);
                    
                    // Add unit price line if there's discount
                    if (item.discount > 0) {
                        const discountRow = document.createElement('div');
                        discountRow.style.fontSize = '10px';
                        discountRow.style.color = '#666';
                        discountRow.innerHTML = `&nbsp;&nbsp;@ ${formatCurrency(item.unit_price)} - Disc ${formatCurrency(item.discount)}`;
                        itemsList.appendChild(discountRow);
                    } else {
                        const priceRow = document.createElement('div');
                        priceRow.style.fontSize = '10px';
                        priceRow.style.color = '#666';
                        priceRow.innerHTML = `&nbsp;&nbsp;@ ${formatCurrency(item.unit_price)}`;
                        itemsList.appendChild(priceRow);
                    }
                  });
                } else {
                  // No items found
                  const noItemsRow = document.createElement('div');
                  noItemsRow.className = 'item-row';
                  noItemsRow.innerHTML = '<div class="item-name">Tidak ada item</div>';
                  itemsList.appendChild(noItemsRow);
                }
                
                // Update totals
                document.getElementById('subtotalAmount').textContent = formatCurrency(data.subtotal);
                document.getElementById('discountAmount').textContent = formatCurrency(data.discount);
                document.getElementById('totalAmount').textContent = formatCurrency(data.total);
                document.getElementById('paidAmount').textContent = formatCurrency(data.paid);
                document.getElementById('changeAmount').textContent = formatCurrency(data.change_amount);
                
                // Auto print after loading
                setTimeout(() => {
                    window.print();
                }, 1000);
                
            } catch (error) {
                console.error('Error loading receipt data:', error);
                alert('Error loading receipt data: ' + error.message);
            }
        };

        // Load store settings
        const loadStoreSettings = async () => {
            try {
                const response = await fetch(`${API_BASE_URL}/settings`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    credentials: 'include'
                });
                
                if (!response.ok) {
                    console.log('Could not load store settings');
                    return;
                }
                
                const settings = await response.json();
                
                if (settings.store_name) {
                    document.getElementById('storeName').textContent = settings.store_name;
                }
                if (settings.store_address) {
                    document.getElementById('storeAddress').textContent = settings.store_address;
                }
                if (settings.store_phone) {
                    document.getElementById('storePhone').textContent = `Telp: ${settings.store_phone}`;
                }
            } catch (error) {
                console.error('Error loading store settings:', error);
            }
        };

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            loadStoreSettings();
            loadReceiptData();
        });
    </script>
</body>
</html> 